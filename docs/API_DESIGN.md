# API Design

## Overview

The OYL REST API follows standard HTTP conventions. All endpoints are versioned under `/api/v1`. Interactive documentation is auto-generated by FastAPI and available at:

- **Swagger UI**: `http://localhost:8000/docs`
- **ReDoc**: `http://localhost:8000/redoc`

---

## Design Principles

- **RESTful resources**: URLs identify resources; HTTP methods express intent (`GET`, `POST`, `PUT`, `DELETE`).
- **JSON everywhere**: All request and response bodies use `application/json` (except file uploads which use `multipart/form-data`).
- **Consistent error format**: All errors return a JSON object with a `detail` field.
- **Idempotent reads**: `GET` requests never mutate state.
- **Hierarchical nesting for creation**: Child resources are created under their parent's URL (e.g., `POST /tenants/{id}/workspaces`).
- **Flat retrieval**: Resources are retrieved by their own ID (e.g., `GET /workspaces/{id}`).

---

## Base URL

```
http://localhost:8000/api/v1
```

---

## Authentication & Authorization

Include a JWT Bearer token in every request (except tenant creation):

```
Authorization: Bearer <token>
```

Tokens are issued as HS256 JWTs. Configuration:

| Setting | Default | Env var |
|---------|---------|---------|
| Signing algorithm | `HS256` | `ALGORITHM` |
| Expiry | 60 minutes | `ACCESS_TOKEN_EXPIRE_MINUTES` |
| Secret key | — | `SECRET_KEY` |

### Multi-Tenancy Header

Every request must also carry:

```
X-Tenant-ID: <tenant-uuid>
```

The server uses this header to scope all database queries to the correct tenant.

---

## API Versioning

The URL path carries the version: `/api/v1`, `/api/v2`, etc. Breaking changes will be introduced in a new version while the previous version remains available for a deprecation window.

---

## Pagination

List endpoints support cursor-based pagination via query parameters:

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `limit` | integer | 20 | Maximum items to return (max 100) |
| `offset` | integer | 0 | Number of items to skip |

**Response envelope**:
```json
{
  "items": [...],
  "total": 42,
  "limit": 20,
  "offset": 0
}
```

---

## Filtering & Search

Where supported, list endpoints accept query parameters for filtering:

```
GET /workspaces?tenant_id=<uuid>&name=engineering
```

---

## Error Handling

All errors follow this response body:

```json
{
  "detail": "Human-readable error message"
}
```

| HTTP Status | Meaning |
|-------------|---------|
| `400` | Bad request / validation failed |
| `401` | Missing or invalid JWT |
| `403` | Forbidden – insufficient permissions |
| `404` | Resource not found |
| `409` | Conflict – resource already exists (e.g., duplicate tenant name) |
| `422` | Unprocessable Entity – Pydantic schema validation error |
| `500` | Internal server error |

**Example 422 response**:
```json
{
  "detail": [
    {
      "loc": ["body", "name"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

---

## Endpoints

### Health Check

#### `GET /health`

Returns the application status. No authentication required.

**Response `200`**:
```json
{
  "status": "ok",
  "version": "0.1.0"
}
```

---

### Tenants

#### `POST /api/v1/tenants`

Create a new tenant (organisation/customer).

**Request body**:
```json
{
  "name": "Acme Corp"
}
```

**Response `201`**:
```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "name": "Acme Corp",
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-15T10:30:00Z"
}
```

**Errors**: `409` if `name` already exists.

---

#### `GET /api/v1/tenants/{tenant_id}`

Retrieve a tenant by ID.

**Path parameters**:

| Parameter | Type | Description |
|-----------|------|-------------|
| `tenant_id` | string (UUID) | Tenant identifier |

**Response `200`**:
```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "name": "Acme Corp",
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-15T10:30:00Z"
}
```

**Errors**: `404` if not found.

---

### Workspaces

#### `POST /api/v1/tenants/{tenant_id}/workspaces`

Create a workspace within a tenant.

**Path parameters**:

| Parameter | Type | Description |
|-----------|------|-------------|
| `tenant_id` | string (UUID) | Owning tenant |

**Request body**:
```json
{
  "name": "Engineering"
}
```

**Response `201`**:
```json
{
  "id": "a1b2c3d4-...",
  "tenant_id": "3fa85f64-...",
  "name": "Engineering",
  "created_at": "2024-01-15T10:31:00Z",
  "updated_at": "2024-01-15T10:31:00Z"
}
```

**Errors**: `404` if `tenant_id` does not exist.

---

#### `GET /api/v1/workspaces/{workspace_id}`

Retrieve a workspace by ID.

**Response `200`**:
```json
{
  "id": "a1b2c3d4-...",
  "tenant_id": "3fa85f64-...",
  "name": "Engineering",
  "created_at": "2024-01-15T10:31:00Z",
  "updated_at": "2024-01-15T10:31:00Z"
}
```

**Errors**: `404` if not found.

---

### Teammates

#### `POST /api/v1/workspaces/{workspace_id}/teammates`

Create an AI agent (teammate) within a workspace.

**Path parameters**:

| Parameter | Type | Description |
|-----------|------|-------------|
| `workspace_id` | string (UUID) | Owning workspace |

**Request body**:
```json
{
  "name": "Support Bot",
  "orchestration_config": {
    "strategy": "round_robin",
    "assistants": []
  }
}
```

**Response `201`**:
```json
{
  "id": "b2c3d4e5-...",
  "workspace_id": "a1b2c3d4-...",
  "name": "Support Bot",
  "orchestration_config": { "strategy": "round_robin", "assistants": [] },
  "created_at": "2024-01-15T10:32:00Z",
  "updated_at": "2024-01-15T10:32:00Z"
}
```

**Errors**: `404` if `workspace_id` does not exist.

---

#### `GET /api/v1/teammates/{teammate_id}`

Retrieve a teammate by ID.

**Response `200`**:
```json
{
  "id": "b2c3d4e5-...",
  "workspace_id": "a1b2c3d4-...",
  "name": "Support Bot",
  "orchestration_config": null,
  "created_at": "2024-01-15T10:32:00Z",
  "updated_at": "2024-01-15T10:32:00Z"
}
```

**Errors**: `404` if not found.

---

### Assistants

#### `POST /api/v1/teammates/{teammate_id}/assistants`

Create an assistant (LLM configuration) under a teammate.

**Path parameters**:

| Parameter | Type | Description |
|-----------|------|-------------|
| `teammate_id` | string (UUID) | Owning teammate |

**Request body**:
```json
{
  "name": "DeepSeek Assistant"
}
```

**Response `201`**:
```json
{
  "id": "c3d4e5f6-...",
  "teammate_id": "b2c3d4e5-...",
  "name": "DeepSeek Assistant",
  "created_at": "2024-01-15T10:33:00Z",
  "updated_at": "2024-01-15T10:33:00Z"
}
```

**Errors**: `404` if `teammate_id` does not exist.

---

#### `GET /api/v1/assistants/{assistant_id}`

Retrieve an assistant by ID.

**Response `200`**:
```json
{
  "id": "c3d4e5f6-...",
  "teammate_id": "b2c3d4e5-...",
  "name": "DeepSeek Assistant",
  "created_at": "2024-01-15T10:33:00Z",
  "updated_at": "2024-01-15T10:33:00Z"
}
```

**Errors**: `404` if not found.

---

### Knowledge Management

#### `POST /api/v1/assistants/{assistant_id}/knowledge/upload`

Upload a document to an assistant's knowledge base. The file is saved and its text content is extracted. Chunking and vector embedding happen asynchronously (future: Celery task).

**Content-Type**: `multipart/form-data`

**Form fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `file` | binary | Yes | The document file (PDF, TXT, DOCX, …) |

**Response `201`**:
```json
{
  "id": "d4e5f6a7-...",
  "knowledge_base_id": "e5f6a7b8-...",
  "file_path": "/tmp/oyl_uploads/report.pdf",
  "file_type": "application/pdf",
  "raw_content": "Extracted text content...",
  "processed_status": "pending",
  "created_at": "2024-01-15T10:34:00Z",
  "updated_at": "2024-01-15T10:34:00Z"
}
```

**Errors**: `404` if `assistant_id` does not exist.

---

#### `POST /api/v1/assistants/{assistant_id}/instruction`

Set or update the system prompt (instruction) for an assistant. If an instruction already exists it is replaced (upsert).

**Request body**:
```json
{
  "system_prompt": "You are a helpful customer support agent. Answer only based on provided documents."
}
```

**Response `201`**:
```json
{
  "id": "f6a7b8c9-...",
  "assistant_id": "c3d4e5f6-...",
  "system_prompt": "You are a helpful customer support agent. Answer only based on provided documents.",
  "updated_at": "2024-01-15T10:35:00Z"
}
```

**Errors**: `404` if `assistant_id` does not exist.

---

### Orchestration & Query

#### `POST /api/v1/teammates/{teammate_id}/query`

Send a natural language query to a teammate. The teammate routes the query to its configured assistants, performs RAG retrieval, and returns a response.

**Request body**:
```json
{
  "query": "What is the refund policy?",
  "context": {}
}
```

**Response `200`**:
```json
{
  "teammate_id": "b2c3d4e5-...",
  "query": "What is the refund policy?",
  "result": "Based on the uploaded documents, the refund policy states..."
}
```

> **Note**: Full orchestration (RAG retrieval + LLM call) is a work in progress. The current implementation returns a placeholder result. See [issue #1](https://github.com/germanchung-gerck/oyl/issues/1).

**Errors**: `404` if `teammate_id` does not exist.

---

## Rate Limiting

Rate limiting is planned using Redis counters (per-tenant, per-endpoint). Configuration will be exposed via environment variables:

```
RATE_LIMIT_REQUESTS_PER_MINUTE=60
RATE_LIMIT_BURST=10
```

When a rate limit is exceeded the server returns:

```
HTTP 429 Too Many Requests
Retry-After: 15
```

---

## Request / Response Examples (cURL)

### Create a tenant
```bash
curl -X POST http://localhost:8000/api/v1/tenants \
  -H "Content-Type: application/json" \
  -d '{"name": "Acme Corp"}'
```

### Create a workspace
```bash
curl -X POST http://localhost:8000/api/v1/tenants/<tenant_id>/workspaces \
  -H "Content-Type: application/json" \
  -H "X-Tenant-ID: <tenant_id>" \
  -H "Authorization: Bearer <token>" \
  -d '{"name": "Engineering"}'
```

### Upload a document
```bash
curl -X POST http://localhost:8000/api/v1/assistants/<assistant_id>/knowledge/upload \
  -H "X-Tenant-ID: <tenant_id>" \
  -H "Authorization: Bearer <token>" \
  -F "file=@/path/to/document.pdf"
```

### Query a teammate
```bash
curl -X POST http://localhost:8000/api/v1/teammates/<teammate_id>/query \
  -H "Content-Type: application/json" \
  -H "X-Tenant-ID: <tenant_id>" \
  -H "Authorization: Bearer <token>" \
  -d '{"query": "What is the refund policy?"}'
```
